<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heisig Mnemonic Generator</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #f0f0f0;
  display: flex;
  justify-content: center;
  padding: 2rem 1rem;
  min-height: 100vh;
}
.container { max-width: 520px; width: 100%; }
h1 { text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem; }
.input-row {
  display: flex; gap: 0.5rem; margin-bottom: 1rem;
}
.input-row input {
  flex: 1; font-size: 1.5rem; padding: 0.5rem 0.75rem;
  border: 2px solid #ccc; border-radius: 8px; text-align: center;
}
.input-row button, .story-section button {
  padding: 0.5rem 1rem; border: none; border-radius: 8px;
  background: #4a90d9; color: #fff; font-size: 1rem; cursor: pointer;
}
.input-row button:hover, .story-section button:hover { background: #357abd; }
.card {
  background: #fff; border-radius: 12px; padding: 1.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;
}
.card.visible { display: block; }
.char-display {
  font-size: 4rem; text-align: center; line-height: 1.2;
  margin-bottom: 0.25rem;
}
.keyword {
  text-align: center; font-size: 1.4rem; font-weight: 600;
  margin-bottom: 1rem;
}
.book-nums { text-align: center; color: #888; font-size: 0.85rem; margin-bottom: 1rem; }
.detail { margin-bottom: 0.5rem; }
.detail .label { font-weight: 600; color: #555; }
.story-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; }
.story-section .api-row {
  display: flex; gap: 0.5rem; margin-bottom: 0.5rem;
}
.story-section .api-row select, .story-section .api-row input {
  padding: 0.4rem; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem;
}
.story-section .api-row input { flex: 1; }
.story-text {
  margin-top: 0.75rem; font-style: italic; color: #333;
  line-height: 1.5; min-height: 1.5em;
}
.error { color: #c00; }
.not-found { text-align: center; color: #888; padding: 2rem 0; }
</style>
</head>
<body>
<div class="container">
  <h1>Heisig Mnemonic Generator</h1>
  <div class="input-row">
    <input type="text" id="charInput" placeholder="Enter a character (e.g. 学)" maxlength="4">
    <button onclick="decompose()">Decompose</button>
  </div>
  <div class="card" id="card">
    <div class="char-display" id="charDisplay"></div>
    <div class="keyword" id="keyword"></div>
    <div class="book-nums" id="bookNums"></div>
    <div class="detail" id="reading"></div>
    <div class="detail" id="components"></div>
    <div class="detail" id="layout"></div>
    <div class="story-section">
      <div class="api-row">
        <select id="provider">
          <option value="anthropic">Anthropic</option>
          <option value="openai">OpenAI</option>
        </select>
        <input type="password" id="apiKey" placeholder="API key">
        <button onclick="generateStory()">Generate Story</button>
      </div>
      <div class="story-text" id="storyText"></div>
    </div>
  </div>
  <div class="card not-found" id="notFound">Character not found in Heisig data.</div>
</div>

<script>
let heisigData = null;
let currentInfo = null;
let currentChar = '';

fetch('heisig_data.json')
  .then(r => r.json())
  .then(d => { heisigData = d; })
  .catch(() => alert('Failed to load heisig_data.json'));

document.getElementById('charInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') decompose();
});

function decompose() {
  const input = document.getElementById('charInput').value.trim();
  if (!input || !heisigData) return;
  const char = [...input][0];
  currentChar = char;
  const info = heisigData[char];
  const card = document.getElementById('card');
  const nf = document.getElementById('notFound');

  if (!info) {
    card.classList.remove('visible');
    nf.classList.add('visible');
    currentInfo = null;
    return;
  }

  currentInfo = info;
  nf.classList.remove('visible');
  card.classList.add('visible');

  document.getElementById('charDisplay').textContent = char;
  document.getElementById('keyword').textContent = info.keyword || '';

  const nums = [];
  if (info.RSH_number) nums.push('RSH #' + info.RSH_number);
  if (info.RTH_number) nums.push('RTH #' + info.RTH_number);
  if (info.RTK_number) nums.push('RTK #' + info.RTK_number);
  document.getElementById('bookNums').textContent = nums.join(' · ') || '';

  setDetail('reading', 'Reading', info.reading);
  setDetail('components', 'Components', info.components_detail || info.decomposition);
  setDetail('layout', 'Layout', info.spatial);
  document.getElementById('storyText').textContent = '';
}

function setDetail(id, label, value) {
  const el = document.getElementById(id);
  if (value) {
    el.style.display = '';
    el.innerHTML = '<span class="label">' + label + ':</span> ' + escapeHtml(value);
  } else {
    el.style.display = 'none';
  }
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

async function generateStory() {
  if (!currentInfo) return;
  const apiKey = document.getElementById('apiKey').value.trim();
  const provider = document.getElementById('provider').value;
  const storyEl = document.getElementById('storyText');

  if (!apiKey) { storyEl.innerHTML = '<span class="error">Enter an API key first.</span>'; return; }

  storyEl.textContent = 'Generating...';

  const userPrompt = [
    'Character: ' + currentChar,
    'Keyword: ' + (currentInfo.keyword || currentChar),
    'Components: ' + (currentInfo.components_detail || currentInfo.decomposition || ''),
    'Layout: ' + (currentInfo.spatial || ''),
    'Write a short mnemonic story.'
  ].join('\n');

  const systemPrompt = 'You are a mnemonic story writer for learning Chinese/Japanese characters using the Heisig method. Given a character\'s keyword and its components, write a vivid, memorable 1-3 sentence story that connects the component meanings to the keyword. Be creative and use sensory details.';

  try {
    let text;
    if (provider === 'openai') {
      const resp = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
        body: JSON.stringify({
          model: 'gpt-4o', max_tokens: 256,
          messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userPrompt }]
        })
      });
      const data = await resp.json();
      if (data.error) throw new Error(data.error.message);
      text = data.choices[0].message.content;
    } else {
      const resp = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514', max_tokens: 256,
          system: systemPrompt,
          messages: [{ role: 'user', content: userPrompt }]
        })
      });
      const data = await resp.json();
      if (data.error) throw new Error(data.error.message);
      text = data.content[0].text;
    }
    storyEl.textContent = text;
  } catch (e) {
    storyEl.innerHTML = '<span class="error">Error: ' + escapeHtml(e.message) + '</span>';
  }
}
</script>
</body>
</html>
